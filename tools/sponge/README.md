## Sponges

This folder contains tools for creating temperature and salinity sponges for use in MOM6 based on the GLORYS reanalysis.

## preproc_scripts

Scripts to subset, average, and fill the GLORYS data on the uda to preprocess it for the python scripts.

# Regional Subsetting

Regional subsets of the GLORYS reanalysis are created using `ncks` in `get_so_monthly.csh` and `get_thetao_monthly.csh`. 
You should adjust the regional subset in the script to match the region of interest.

For example:
```
ncks -d latitude,40.,90. -d longitude,0.,360 filein.nc fileout.nc
```

# Scripts

As written these preprocessing scripts must be run in three stages.
1. First, subset the temperature and salinity and create monthly averages
```
sbatch get_thetao_monthly.csh <YEAR> <MONTH>
sbatch get_so_monthly.csh <YEAR> <MONTH>
```

2. Next, fill the data
```
sbatch fill_glorys_nn_monthly.csh <YEAR> <MONTH>
```

3. Finally, once the filled data for every month in a given year has been created, the merge script can be used.
```
sbatch merge_so_thetao_year.csh <YEAR>
```

This should produce data that is compatible with `write_nudging_data.py`

## Using these files in MOM6

To use the sponges generated by these scripts in MOM6 we recommend the following settings:
```
#override SPONGE = True
#override SPONGE_UV = False
#override SPONGE_DAMPING_FILE = "damping_full_t_90d.nc"
#override SPONGE_IDAMP_VAR = "Idamp"
#override SPONGE_STATE_FILE = "glorys_sponge_monthly_bnd_${fyear}.nc"
#override SPONGE_PTEMP_VAR = "thetao"
#override SPONGE_SALT_VAR = "so"
#override SPONGE_ETA_VAR = "depth"
#override INTERPOLATE_SPONGE_TIME_SPACE = True
#override SPONGE_DATA_ONGRID = True
```
These should be added to `MOM_override` in the experiment of the xml.

In the xml, add the paths to the files needed for sponges so that they are include in the `INPUT` directory.
```
<!-- Two new files for the nudging: -->
<dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
  <dataSource site="ncrc">$(YOUR_PATH)/damping_full_t_90d.nc</dataSource>
</dataFile>
<dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
  <dataSource site="ncrc">$(YOUR_PATH)/glorys_sponge_monthly_${fyear}.nc</dataSource>
</dataFile>
```

